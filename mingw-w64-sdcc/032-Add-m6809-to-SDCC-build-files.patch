From aef47c733a8b9776540a6318f8fdc5977e517f93 Mon Sep 17 00:00:00 2001
From: Tim Stahlhut <stahta01@gmail.com>
Date: Wed, 26 Aug 2020 13:51:10 -0400
Subject: Add m6809 to SDCC build files

---
 sdcc/Makefile.common.in       |  1 +
 sdcc/Makefile.in              |  5 +++++
 sdcc/configure                | 41 +++++++++++++++++++++++++++++++++++
 sdcc/configure.ac             |  8 +++++++
 sdcc/sdas/linksrc/Makefile.in |  6 +++--
 sdcc/sdccconf_in.h            |  6 +++++
 6 files changed, 65 insertions(+), 2 deletions(-)

diff --git a/sdcc/Makefile.common.in b/sdcc/Makefile.common.in
index 412fd5a14..6a53e0242 100644
--- a/sdcc/Makefile.common.in
+++ b/sdcc/Makefile.common.in
@@ -61,6 +61,7 @@ OPT_DISABLE_PDK13       = @OPT_DISABLE_PDK13@
 OPT_DISABLE_PDK14       = @OPT_DISABLE_PDK14@
 OPT_DISABLE_PDK15       = @OPT_DISABLE_PDK15@
 OPT_DISABLE_PDK16       = @OPT_DISABLE_PDK16@
+OPT_DISABLE_MC6809      = @OPT_DISABLE_MC6809@
 
 OPT_ENABLE_DOC          = @OPT_ENABLE_DOC@
 
diff --git a/sdcc/Makefile.in b/sdcc/Makefile.in
index f3b028d0f..e29c74807 100644
--- a/sdcc/Makefile.in
+++ b/sdcc/Makefile.in
@@ -28,6 +28,11 @@ SDCC_AS        += sdas/as6808
 SDCC_LD        += sdcc-ld6808
 endif
 
+ifneq ($(OPT_DISABLE_MC6809), 1)
+SDCC_AS        += sdas/as6809
+SDCC_LD        += sdcc-ld6809
+endif
+
 ifeq ($(OPT_DISABLE_STM8), 0)
 SDCC_AS        += sdas/asstm8
 SDCC_LD        += sdcc-ldstm8
diff --git a/sdcc/configure b/sdcc/configure
index 43ccb6fac..b1d94d13d 100755
--- a/sdcc/configure
+++ b/sdcc/configure
@@ -640,6 +640,7 @@ OPT_DISABLE_PACKIHX
 OPT_DISABLE_DEVICE_LIB
 OPT_DISABLE_UCSIM
 OPT_DISABLE_AVR
+OPT_DISABLE_MC6809
 OPT_DISABLE_PDK16
 OPT_DISABLE_PDK15
 OPT_DISABLE_PDK14
@@ -774,6 +775,7 @@ enable_pdk13_port
 enable_pdk14_port
 enable_pdk15_port
 enable_pdk16_port
+enable_mc6809_port
 enable_ucsim
 enable_device_lib
 enable_packihx
@@ -1449,6 +1451,7 @@ Optional Features:
   --disable-pdk14-port    Excludes the PDK14 port
   --disable-pdk15-port    Excludes the PDK15 port
   --enable-pdk16-port     Includes the PDK16 port
+  --disable-mc6809-port   Excludes the MC6809 port
   --disable-ucsim         Disables configuring and building of ucsim
   --disable-device-lib    Disables building device libraries
   --disable-packihx       Disables building packihx
@@ -8296,6 +8299,32 @@ _ACEOF
   fi
 
 
+  # Check whether --enable-mc6809-port was given.
+if test "${enable_mc6809_port+set}" = set; then :
+  enableval=$enable_mc6809_port;
+fi
+
+
+  if test "$enable_mc6809_port" = "no"; then
+    OPT_DISABLE_MC6809=1
+  else
+    enable_mc6809_port="yes"
+    OPT_DISABLE_MC6809=0
+  fi
+
+
+cat >>confdefs.h <<_ACEOF
+#define OPT_DISABLE_MC6809 $OPT_DISABLE_MC6809
+_ACEOF
+
+
+
+  echo mc6809 >>ports.all
+  if test $OPT_DISABLE_MC6809 = 0; then
+    echo mc6809 >>ports.build
+  fi
+
+
 # Unsupported targets
 ####AC_DO_PORT_ENABLER(avr,   avr,   AVR,   [Includes the AVR port (disabled by default)])
 OPT_DISABLE_AVR=1
@@ -8843,6 +8872,13 @@ if test $OPT_DISABLE_HC08 = 0 || test $OPT_DISABLE_S08 = 0; then
 
 fi
 
+if test $OPT_DISABLE_MC6809 = 0; then
+  ac_config_files="$ac_config_files src/mc6809/Makefile sdas/as6809/Makefile"
+
+  test $OPT_DISABLE_DEVICE_LIB = 0 && ac_config_files="$ac_config_files device/lib/mc6809/Makefile"
+
+fi
+
 if test $OPT_DISABLE_MCS51 = 0; then
   ac_config_files="$ac_config_files src/mcs51/Makefile sdas/as8051/Makefile"
 
@@ -9657,6 +9693,9 @@ do
     "sdas/as6808/Makefile") CONFIG_FILES="$CONFIG_FILES sdas/as6808/Makefile" ;;
     "device/lib/hc08/Makefile") CONFIG_FILES="$CONFIG_FILES device/lib/hc08/Makefile" ;;
     "device/lib/s08/Makefile") CONFIG_FILES="$CONFIG_FILES device/lib/s08/Makefile" ;;
+    "src/mc6809/Makefile") CONFIG_FILES="$CONFIG_FILES src/mc6809/Makefile" ;;
+    "sdas/as6809/Makefile") CONFIG_FILES="$CONFIG_FILES sdas/as6809/Makefile" ;;
+    "device/lib/mc6809/Makefile") CONFIG_FILES="$CONFIG_FILES device/lib/mc6809/Makefile" ;;
     "src/mcs51/Makefile") CONFIG_FILES="$CONFIG_FILES src/mcs51/Makefile" ;;
     "sdas/as8051/Makefile") CONFIG_FILES="$CONFIG_FILES sdas/as8051/Makefile" ;;
     "device/lib/mcs51/Makefile") CONFIG_FILES="$CONFIG_FILES device/lib/mcs51/Makefile" ;;
@@ -10678,6 +10717,7 @@ sdcc ${VERSION} is now configured for
     ds400               ${enable_ds400_port}
     hc08                ${enable_hc08_port}
     s08                 ${enable_s08_port}
+    mc6809              ${enable_mc6809_port}
     mcs51               ${enable_mcs51_port}
     pic14               ${enable_pic14_port}
     pic16               ${enable_pic16_port}
@@ -10753,6 +10793,7 @@ sdcc ${VERSION} is now configured for
     ds400               ${enable_ds400_port}
     hc08                ${enable_hc08_port}
     s08                 ${enable_s08_port}
+    mc6809              ${enable_mc6809_port}
     mcs51               ${enable_mcs51_port}
     pic14               ${enable_pic14_port}
     pic16               ${enable_pic16_port}
diff --git a/sdcc/configure.ac b/sdcc/configure.ac
index 2185793dc..08dca9582 100644
--- a/sdcc/configure.ac
+++ b/sdcc/configure.ac
@@ -784,6 +784,7 @@ AC_DO_PORT(pdk13,    pdk,    PDK13,    [Excludes the PDK13 port])
 AC_DO_PORT(pdk14,    pdk,    PDK14,    [Excludes the PDK14 port])
 AC_DO_PORT(pdk15,    pdk,    PDK15,    [Excludes the PDK15 port])
 AC_DO_PORT_ENABLER(pdk16,    pdk,    PDK16,    [Includes the PDK16 port])
+AC_DO_PORT(mc6809,   mc6809, MC6809,   [Excludes the MC6809 port])
 
 # Unsupported targets
 ####AC_DO_PORT_ENABLER(avr,   avr,   AVR,   [Includes the AVR port (disabled by default)])
@@ -854,6 +855,12 @@ if test $OPT_DISABLE_HC08 = 0 || test $OPT_DISABLE_S08 = 0; then
                                                        device/lib/s08/Makefile])
 fi
 
+if test $OPT_DISABLE_MC6809 = 0; then
+  AC_CONFIG_FILES([src/mc6809/Makefile
+                   sdas/as6809/Makefile])
+  test $OPT_DISABLE_DEVICE_LIB = 0 && AC_CONFIG_FILES([device/lib/mc6809/Makefile])
+fi
+
 if test $OPT_DISABLE_MCS51 = 0; then
   AC_CONFIG_FILES([src/mcs51/Makefile
                    sdas/as8051/Makefile])
@@ -1004,6 +1011,7 @@ sdcc ${VERSION} is now configured for
     ds400               ${enable_ds400_port}
     hc08                ${enable_hc08_port}
     s08                 ${enable_s08_port}
+    mc6809              ${enable_mc6809_port}
     mcs51               ${enable_mcs51_port}
     pic14               ${enable_pic14_port}
     pic16               ${enable_pic16_port}
diff --git a/sdcc/sdas/linksrc/Makefile.in b/sdcc/sdas/linksrc/Makefile.in
index 43e16f54d..91460594e 100644
--- a/sdcc/sdas/linksrc/Makefile.in
+++ b/sdcc/sdas/linksrc/Makefile.in
@@ -63,7 +63,7 @@ transform       = @program_transform_name@
 
 # Compiling entire program or any subproject
 # ------------------------------------------
-all: sdcc-ld8051 sdcc-ldz80 sdcc-ldgb sdcc-ld6808 sdcc-ldstm8 sdcc-ldpdk
+all: sdcc-ld8051 sdcc-ldz80 sdcc-ldgb sdcc-ld6808 sdcc-ldstm8 sdcc-ldpdk sdcc-ld6809
 
 sdcc-ld8051: checkconf $(ASLINK)
 
@@ -73,11 +73,13 @@ sdcc-ldgb: checkconf $(top_builddir)/bin/sdldgb$(EXEEXT)
 
 sdcc-ld6808: checkconf $(top_builddir)/bin/sdld6808$(EXEEXT)
 
+sdcc-ld6809: checkconf $(top_builddir)/bin/sdld6809$(EXEEXT)
+
 sdcc-ldstm8: checkconf $(top_builddir)/bin/sdldstm8$(EXEEXT)
 
 sdcc-ldpdk: checkconf $(top_builddir)/bin/sdldpdk$(EXEEXT)
 
-$(top_builddir)/bin/sdldz80$(EXEEXT) $(top_builddir)/bin/sdldgb$(EXEEXT) $(top_builddir)/bin/sdldstm8$(EXEEXT) $(top_builddir)/bin/sdld6808$(EXEEXT) $(top_builddir)/bin/sdldpdk$(EXEEXT): $(ASLINK)
+$(top_builddir)/bin/sdldz80$(EXEEXT) $(top_builddir)/bin/sdldgb$(EXEEXT) $(top_builddir)/bin/sdldstm8$(EXEEXT) $(top_builddir)/bin/sdld6808$(EXEEXT) $(top_builddir)/bin/sdld6809$(EXEEXT) $(top_builddir)/bin/sdldpdk$(EXEEXT): $(ASLINK)
 	cp -p $(ASLINK) $@
 
 $(ASLINK): $(LKOBJECTS)
diff --git a/sdcc/sdccconf_in.h b/sdcc/sdccconf_in.h
index aeb272488..a5fd97620 100644
--- a/sdcc/sdccconf_in.h
+++ b/sdcc/sdccconf_in.h
@@ -88,6 +88,9 @@
 /* Define to 1 if you have the <treedec/combinations.hpp> header file. */
 #undef HAVE_TREEDEC_COMBINATIONS_HPP
 
+/* Define to 1 if you have the <uchar.h> header file. */
+#undef HAVE_UCHAR_H
+
 /* Define to 1 if you have the <unistd.h> header file. */
 #undef HAVE_UNISTD_H
 
@@ -124,6 +127,9 @@
 /* XXX */
 #undef OPT_DISABLE_HC08
 
+/* XXX */
+#undef OPT_DISABLE_MC6809
+
 /* XXX */
 #undef OPT_DISABLE_MCS51
 
-- 
