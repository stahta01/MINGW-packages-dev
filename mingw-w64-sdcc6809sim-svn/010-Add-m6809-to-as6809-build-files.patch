From 54b6901dd775dd06e02844872b71f24a77d564e6 Mon Sep 17 00:00:00 2001
From: Tim Stahlhut <stahta01@gmail.com>
Date: Wed, 26 Aug 2020 13:51:10 -0400
Subject: Add m6809 to as6809 build files

---
 sdcc/Makefile.common.in       |  1 +
 sdcc/Makefile.in              |  5 +++++
 sdcc/configure                | 35 +++++++++++++++++++++++++++++++++++
 sdcc/configure.ac             |  5 +++++
 sdcc/sdas/linksrc/Makefile.in | 13 ++++++++++---
 sdcc/sdccconf_in.h            |  3 +++
 6 files changed, 59 insertions(+), 3 deletions(-)

diff --git a/sdcc/Makefile.common.in b/sdcc/Makefile.common.in
index e7f1092f0..88beb83e0 100644
--- a/sdcc/Makefile.common.in
+++ b/sdcc/Makefile.common.in
@@ -62,6 +62,7 @@ OPT_DISABLE_PDK13       = @OPT_DISABLE_PDK13@
 OPT_DISABLE_PDK14       = @OPT_DISABLE_PDK14@
 OPT_DISABLE_PDK15       = @OPT_DISABLE_PDK15@
 OPT_DISABLE_PDK16       = @OPT_DISABLE_PDK16@
+OPT_DISABLE_MC6809      = @OPT_DISABLE_MC6809@
 
 OPT_ENABLE_DOC          = @OPT_ENABLE_DOC@
 
diff --git a/sdcc/Makefile.in b/sdcc/Makefile.in
index 6333bb5eb..c5d65cd1a 100644
--- a/sdcc/Makefile.in
+++ b/sdcc/Makefile.in
@@ -28,6 +28,9 @@ SDCC_AS        += sdas/as6808
 SDCC_LD        += sdcc-ld6808
 endif
 
+SDCC_AS        += sdas/as6809
+SDCC_LD        += sdcc-ld6809
+
 ifeq ($(OPT_DISABLE_STM8), 0)
 SDCC_AS        += sdas/asstm8
 SDCC_LD        += sdcc-ldstm8
diff --git a/sdcc/configure b/sdcc/configure
index 140aea8df..04e4f6fbc 100755
--- a/sdcc/configure
+++ b/sdcc/configure
@@ -640,6 +640,7 @@ OPT_DISABLE_PACKIHX
 OPT_DISABLE_DEVICE_LIB
 OPT_DISABLE_UCSIM
 OPT_DISABLE_AVR
+OPT_DISABLE_MC6809
 OPT_DISABLE_PDK16
 OPT_DISABLE_PDK15
 OPT_DISABLE_PDK14
@@ -777,6 +778,7 @@ enable_pdk13_port
 enable_pdk14_port
 enable_pdk15_port
 enable_pdk16_port
+enable_mc6809_port
 enable_ucsim
 enable_device_lib
 enable_packihx
@@ -1464,6 +1466,7 @@ Optional Features:
   --disable-pdk14-port    Excludes the PDK14 port
   --disable-pdk15-port    Excludes the PDK15 port
   --enable-pdk16-port     Includes the PDK16 port
+  --enable-mc6809-port    Includes the MC6809 port
   --disable-ucsim         Disables configuring and building of ucsim
   --disable-device-lib    Disables building device libraries
   --disable-packihx       Disables building packihx
@@ -8337,6 +8340,32 @@ _ACEOF
   fi
 
 
+  # Check whether --enable-mc6809-port was given.
+if test "${enable_mc6809_port+set}" = set; then :
+  enableval=$enable_mc6809_port;
+fi
+
+
+  if test "$enable_mc6809_port" = "yes"; then
+    OPT_DISABLE_MC6809=0
+  else
+    enable_mc6809_port="no"
+    OPT_DISABLE_MC6809=1
+  fi
+
+
+cat >>confdefs.h <<_ACEOF
+#define OPT_DISABLE_MC6809 $OPT_DISABLE_MC6809
+_ACEOF
+
+
+
+  echo mc6809 >>ports.all
+  if test $OPT_DISABLE_MC6809 = 0; then
+    echo mc6809 >>ports.build
+  fi
+
+
 # Unsupported targets
 ####AC_DO_PORT_ENABLER(avr,   avr,   AVR,   [Includes the AVR port (disabled by default)])
 OPT_DISABLE_AVR=1
@@ -8884,6 +8913,8 @@ if test $OPT_DISABLE_HC08 = 0 || test $OPT_DISABLE_S08 = 0; then
 
 fi
 
+  ac_config_files="$ac_config_files sdas/as6809/Makefile"
+
 if test $OPT_DISABLE_MCS51 = 0; then
   ac_config_files="$ac_config_files src/mcs51/Makefile sdas/as8051/Makefile"
 
@@ -9698,6 +9732,7 @@ do
     "sdas/as6808/Makefile") CONFIG_FILES="$CONFIG_FILES sdas/as6808/Makefile" ;;
     "device/lib/hc08/Makefile") CONFIG_FILES="$CONFIG_FILES device/lib/hc08/Makefile" ;;
     "device/lib/s08/Makefile") CONFIG_FILES="$CONFIG_FILES device/lib/s08/Makefile" ;;
+    "sdas/as6809/Makefile") CONFIG_FILES="$CONFIG_FILES sdas/as6809/Makefile" ;;
     "src/mcs51/Makefile") CONFIG_FILES="$CONFIG_FILES src/mcs51/Makefile" ;;
     "sdas/as8051/Makefile") CONFIG_FILES="$CONFIG_FILES sdas/as8051/Makefile" ;;
     "device/lib/mcs51/Makefile") CONFIG_FILES="$CONFIG_FILES device/lib/mcs51/Makefile" ;;
diff --git a/sdcc/configure.ac b/sdcc/configure.ac
index 922ae2841..7c56204f8 100644
--- a/sdcc/configure.ac
+++ b/sdcc/configure.ac
@@ -785,6 +785,7 @@ AC_DO_PORT(pdk13,    pdk,    PDK13,    [Excludes the PDK13 port])
 AC_DO_PORT(pdk14,    pdk,    PDK14,    [Excludes the PDK14 port])
 AC_DO_PORT(pdk15,    pdk,    PDK15,    [Excludes the PDK15 port])
 AC_DO_PORT_ENABLER(pdk16,    pdk,    PDK16,    [Includes the PDK16 port])
+AC_DO_PORT_ENABLER(mc6809,   mc6809, MC6809,   [Includes the MC6809 port])
 
 # Unsupported targets
 ####AC_DO_PORT_ENABLER(avr,   avr,   AVR,   [Includes the AVR port (disabled by default)])
@@ -855,6 +856,8 @@ if test $OPT_DISABLE_HC08 = 0 || test $OPT_DISABLE_S08 = 0; then
                                                        device/lib/s08/Makefile])
 fi
 
+  AC_CONFIG_FILES([sdas/as6809/Makefile])
+
 if test $OPT_DISABLE_MCS51 = 0; then
   AC_CONFIG_FILES([src/mcs51/Makefile
                    sdas/as8051/Makefile])
diff --git a/sdcc/sdas/linksrc/Makefile.in b/sdcc/sdas/linksrc/Makefile.in
index 43e16f54d..8e815aa3d 100644
--- a/sdcc/sdas/linksrc/Makefile.in
+++ b/sdcc/sdas/linksrc/Makefile.in
@@ -63,7 +63,7 @@ transform       = @program_transform_name@
 
 # Compiling entire program or any subproject
 # ------------------------------------------
-all: sdcc-ld8051 sdcc-ldz80 sdcc-ldgb sdcc-ld6808 sdcc-ldstm8 sdcc-ldpdk
+all: sdcc-ld8051 sdcc-ldz80 sdcc-ldgb sdcc-ld6808 sdcc-ldstm8 sdcc-ldpdk sdcc-ld6809
 
 sdcc-ld8051: checkconf $(ASLINK)
 
@@ -73,11 +73,13 @@ sdcc-ldgb: checkconf $(top_builddir)/bin/sdldgb$(EXEEXT)
 
 sdcc-ld6808: checkconf $(top_builddir)/bin/sdld6808$(EXEEXT)
 
+sdcc-ld6809: checkconf $(top_builddir)/bin/sdld6809$(EXEEXT)
+
 sdcc-ldstm8: checkconf $(top_builddir)/bin/sdldstm8$(EXEEXT)
 
 sdcc-ldpdk: checkconf $(top_builddir)/bin/sdldpdk$(EXEEXT)
 
-$(top_builddir)/bin/sdldz80$(EXEEXT) $(top_builddir)/bin/sdldgb$(EXEEXT) $(top_builddir)/bin/sdldstm8$(EXEEXT) $(top_builddir)/bin/sdld6808$(EXEEXT) $(top_builddir)/bin/sdldpdk$(EXEEXT): $(ASLINK)
+$(top_builddir)/bin/sdldz80$(EXEEXT) $(top_builddir)/bin/sdldgb$(EXEEXT) $(top_builddir)/bin/sdldstm8$(EXEEXT) $(top_builddir)/bin/sdld6808$(EXEEXT) $(top_builddir)/bin/sdld6809$(EXEEXT) $(top_builddir)/bin/sdldpdk$(EXEEXT): $(ASLINK)
 	cp -p $(ASLINK) $@
 
 $(ASLINK): $(LKOBJECTS)
@@ -98,6 +100,11 @@ install: all installdirs
 	  $(INSTALL) $(top_builddir)/bin/sdld6808$(EXEEXT) $(DESTDIR)$(bindir)/`echo 'sdld6808' | sed '$(transform)'`$(EXEEXT); \
 	  $(STRIP) $(DESTDIR)$(bindir)/`echo 'sdld6808' | sed '$(transform)'`$(EXEEXT); \
 	fi
+	if [ "`grep mc6809 $(top_builddir)/ports.all`" = "mc6809" ]; \
+	then \
+	  $(INSTALL) $(top_builddir)/bin/sdld6809$(EXEEXT) $(DESTDIR)$(bindir)/`echo 'sdld6809' | sed '$(transform)'`$(EXEEXT); \
+	  $(STRIP) $(DESTDIR)$(bindir)/`echo 'sdld6809' | sed '$(transform)'`$(EXEEXT); \
+	fi
 	if [ "`grep z80 $(top_builddir)/ports.build`" = "z80" ]; \
 	then \
 	  $(INSTALL) $(top_builddir)/bin/sdldz80$(EXEEXT) $(DESTDIR)$(bindir)/`echo 'sdldz80' | sed '$(transform)'`$(EXEEXT); \
@@ -114,7 +121,7 @@ install: all installdirs
 # Deleting all the installed files
 # --------------------------------
 uninstall:
-	for ld in $(top_builddir)/bin/sdld $(top_builddir)/bin/sdldz80 $(top_builddir)/bin/sdldgb $(top_builddir)/bin/sdldstm8 $(top_builddir)/bin/sdld6808 $(top_builddir)/bin/sdldpdk; \
+	for ld in $(top_builddir)/bin/sdld $(top_builddir)/bin/sdldz80 $(top_builddir)/bin/sdldgb $(top_builddir)/bin/sdldstm8 $(top_builddir)/bin/sdld6808 $(top_builddir)/bin/sdld6809 $(top_builddir)/bin/sdldpdk; \
 	do \
 	  rm -f $(DESTDIR)$(bindir)/`echo \`basename $$ld\` | sed '$(transform)'`$(EXEEXT); \
 	done
diff --git a/sdcc/sdccconf_in.h b/sdcc/sdccconf_in.h
index cff71c492..eb499cf65 100644
--- a/sdcc/sdccconf_in.h
+++ b/sdcc/sdccconf_in.h
@@ -127,6 +127,9 @@
 /* XXX */
 #undef OPT_DISABLE_HC08
 
+/* XXX */
+#undef OPT_DISABLE_MC6809
+
 /* XXX */
 #undef OPT_DISABLE_MCS51
 
-- 
