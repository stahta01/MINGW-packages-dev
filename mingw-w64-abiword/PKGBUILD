# Contributor: Tim Stahlhut <stahta01@gmail.com>

_realname=abiword
_sourcedir=${_realname}
pkgbase=mingw-w64-${_realname}
pkgname=("${MINGW_PACKAGE_PREFIX}-${_realname}")
#provides=("${MINGW_PACKAGE_PREFIX}-${_realname}")
#conflicts=("${MINGW_PACKAGE_PREFIX}-${_realname}")
pkgver=3.0.4
pkgrel=1
pkgdesc="Word Processor (mingw-w64)"
arch=('any')
url="https://www.abisource.com"
license=('GPL')
options=('!strip' 'debug' '!makeflags')
#options=('strip' '!debug' '!makeflags')
depends=(
  ${MINGW_PACKAGE_PREFIX}-goffice
  ${MINGW_PACKAGE_PREFIX}-fribidi
  ${MINGW_PACKAGE_PREFIX}-wv
  ${MINGW_PACKAGE_PREFIX}-librsvg
  ${MINGW_PACKAGE_PREFIX}-enchant
  ${MINGW_PACKAGE_PREFIX}-desktop-file-utils
  ${MINGW_PACKAGE_PREFIX}-redland
  ${MINGW_PACKAGE_PREFIX}-libical
  ${MINGW_PACKAGE_PREFIX}-gtk-update-icon-cache
  ${MINGW_PACKAGE_PREFIX}-loudmouth
  ${MINGW_PACKAGE_PREFIX}-libwpg
  ${MINGW_PACKAGE_PREFIX}-libwps
  ${MINGW_PACKAGE_PREFIX}-libwmf
  ${MINGW_PACKAGE_PREFIX}-link-grammar
  ${MINGW_PACKAGE_PREFIX}-gtkmathview
  ${MINGW_PACKAGE_PREFIX}-aiksaurus
  ${MINGW_PACKAGE_PREFIX}-libxslt
  ${MINGW_PACKAGE_PREFIX}-libsoup
  ${MINGW_PACKAGE_PREFIX}-libots
  ${MINGW_PACKAGE_PREFIX}-libgsf
  ${MINGW_PACKAGE_PREFIX}-psiconv )
makedepends=(
  ${MINGW_PACKAGE_PREFIX}-boost
  ${MINGW_PACKAGE_PREFIX}-gobject-introspection
  ${MINGW_PACKAGE_PREFIX}-python-gobject
  ${MINGW_PACKAGE_PREFIX}-pkgconfig
  ${MINGW_PACKAGE_PREFIX}-libwpd 
  ${MINGW_PACKAGE_PREFIX}-libwps
  ${MINGW_PACKAGE_PREFIX}-python2-gobject
  ${MINGW_PACKAGE_PREFIX}-python-gobject
  autoconf-archive )
optdepends=()
source=(https://www.abisource.com/downloads/$pkgname/$pkgver/source/$pkgname-$pkgver.tar.gz)
sha256sums=('SKIP')

prepare() {
  cd ${srcdir}/${_sourcedir}

# https://github.com/archlinux/svntogit-packages/blob/packages/abiword/trunk/PKGBUILD

  libtoolize --force
  autoreconf -fi
}

build() {
  [[ -d "${srcdir}"/build-${CARCH} ]] && rm -rf "${srcdir}"/build-${CARCH}
  mkdir -p "${srcdir}"/build-${CARCH} && cd "${srcdir}"/build-${CARCH}

  CPPFLAGS+=" -Wno-deprecated-declarations"

  # configure option --disable-silent-rules useful to aid in debugging

  ../${_sourcedir}/configure \
      --prefix=${MINGW_PREFIX} \
      --host=${MINGW_CHOST} \
      --target=${MINGW_CHOST} \
      --build=${MINGW_CHOST} \
      --enable-shared \
      --disable-static \
      --without-psiconv \
      --disable-introspection \
      --disable-silent-rules

#  local WINPREFIX=$(cygpath -m ${MINGW_PREFIX})
#  local UNIXPREFIX=$(cygpath -u ${MINGW_PREFIX})
#
#  # the local project libtool is having problems with linker search path
#  # libtool:   error: Could not determine the host path corresponding to
#  sed -i "s|-L${WINPREFIX}|-L${UNIXPREFIX}|g" "${srcdir}/build-${CARCH}/src/Makefile"

  make -j1 V=1
}

package() {
  cd "${srcdir}"/build-${CARCH}

  make DESTDIR="${pkgdir}" install

#  install -Dm644 ${srcdir}/${_sourcedir}/COPYING ${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}/LICENSE
#  install -Dm644 ${srcdir}/${_sourcedir}/COPYING-gpl2 ${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}/COPYING-gpl2
#  install -Dm644 ${srcdir}/${_sourcedir}/COPYING-gpl3 ${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}/COPYING-gpl3
}
